name: Build and Deploy

on:
  push:
    branches:
      - dev

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '23.4.0' # Specify Node.js version

      - name: Upgrade npm to 11.5.2
        run: npm install -g npm@11.5.2
      # - name: Install Yarn
      #   run: npm install -g yarn

      - name: Install dependencies
        run: npm install

      # - name: Run ESLint
      #   run: npx eslint . --max-warnings=999

      - name: Create .env file
        run: echo "${{ secrets.ENV }}" | base64 -d > ${{ secrets.ENV_FILE }}

      - name: Build project
        env:
          CI: false  # Prevent warnings from being treated as errors
        run: npm run build

      - name: copy htaccess
        run:  cp .htaccess ./build/

      - name: Clean up and Deploy using SFTP
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          CONTABO_HOST: ${{ secrets.CONTABO_HOST }}
          CONTABO_USER: ${{ secrets.CONTABO_USER }}
          APP_DIR: ${{ secrets.APP_DIR }}
          ENV_FILE: ${{ secrets.ENV_FILE }}
        run: |
          # Save the private key securely
          echo "${SSH_PRIVATE_KEY}" > private_key.pem
          chmod 600 private_key.pem
          # Clean up old files on the server
          ssh -i private_key.pem -o StrictHostKeyChecking=no ${CONTABO_USER}@${CONTABO_HOST} << EOF
          echo "Cleaning up old files in ${APP_DIR}..."
          rm -rvf ${APP_DIR}/*
          EOF
          # Upload new files
          sftp -i private_key.pem -o StrictHostKeyChecking=no ${CONTABO_USER}@${CONTABO_HOST} << EOF
          put -r ./build/* ${APP_DIR}/
          put .htaccess ${APP_DIR}/
          bye
          EOF
          # Cleanup local private key file
          rm private_key.pem
        shell: bash
